# 地形高度模块设计

## 模块概述

地形高度模块是 OpenEarth 系统的地形网格生成核心，负责基于高度图瓦片数据生成地球表面的3D地形网格。该模块专注于地形网格的生成和高度查询，不处理贴图相关的功能，为地球提供真实的地形起伏效果。

该模块采用基于 Babylon.js 的 Mesh 和 VertexData 架构设计，通过 TerrainMeshGenerator 实现地形网格生成的核心功能。高度图数据处理使用 terrain-rgb 格式，通过RGB值计算高程数据，支持全球范围的高精度地形数据。地形网格生成通过双线性插值将2D高程数据转换为3D顶点坐标，自动计算法线向量，生成适合GPU渲染的三角形网格。性能优化采用视锥剔除技术，只渲染可见的地形块，合并多个地形渲染调用减少绘制开销，使用GPU实例化技术提高大规模地形的渲染效率。该模块通过瓦片加载系统获取terrain-rgb格式的高度图瓦片数据，这些瓦片以灰度图形式存储高程信息，与图像瓦片共享统一的数据加载和缓存机制。

## 模块职责

- **高度图数据处理**：加载和处理terrain-rgb格式的高度图瓦片数据
- **地形网格生成**：基于高程数据生成3D地形网格
- **法线计算**：自动计算地形网格的法线向量
- **高度查询**：提供任意位置的地形高度查询
- **性能优化**：优化地形网格生成和渲染性能

## 类图设计

```mermaid
classDiagram
    class TerrainHeightSystem {
        -scene: Scene
        -camera: Camera
        -terrainMeshGenerator: TerrainMeshGenerator
        -isInitialized: boolean
        -config: TerrainHeightConfig
        +constructor(scene: Scene, camera: Camera, config: TerrainHeightConfig)
        +initialize(): Promise~void~
        +dispose(): void
        +update(cameraPosition: Vector3): void
        +getHeightAt(longitude: number, latitude: number): Promise~number~
        +getTerrainNormal(longitude: number, latitude: number): Promise~Vector3~
        +setConfig(config: TerrainHeightConfig): void
        +getConfig(): TerrainHeightConfig
        +enableTerrainHeight(enabled: boolean): void
        +isTerrainHeightEnabled(): boolean
    }

    class TerrainMeshGenerator {
        -scene: Scene
        -earthRadius: number
        -meshConfig: MeshConfiguration
        -heightMapProvider: string
        -terrainMeshes: Map~string, Mesh~
        -heightDataCache: Map~string, Float32Array~
        -isInitialized: boolean
        +constructor(scene: Scene, earthRadius: number)
        +initialize(): Promise~void~
        +dispose(): void
        +generateTerrainMesh(name: string, bounds: TileBounds, heightData?: Float32Array, resolution?: number): Mesh
        +loadHeightData(tileCoord: TileCoordinate): Promise~Float32Array | null~
        +configure(config: Partial~MeshConfiguration~): void
        +setHeightMapProvider(provider: string): void
        +getConfiguration(): MeshConfiguration
        +clearCache(): void
    }

    class MeshConfiguration {
        +enableHeightMaps: boolean
        +heightScale: number
        +meshResolution: number
        +enableNormalCalculation: boolean
        +normalSmoothing: boolean
    }

    class TerrainHeightConfig {
        +enabled: boolean
        +meshConfig: MeshConfiguration
    }

    class TileBounds {
        +west: number
        +east: number
        +south: number
        +north: number
        +level: number
    }

    class TileCoordinate {
        +x: number
        +y: number
        +z: number
    }

    TerrainHeightSystem --> TerrainMeshGenerator : 使用地形网格生成器
    TerrainHeightSystem --> TerrainHeightConfig : 使用配置

    TerrainMeshGenerator --> MeshConfiguration : 使用网格配置
    TerrainMeshGenerator --> TileBounds : 使用瓦片边界
    TerrainMeshGenerator --> TileCoordinate : 使用瓦片坐标

    TerrainHeightConfig --> MeshConfiguration : 包含网格配置
```

## 状态图设计

```mermaid
stateDiagram-v2
    [*] --> 未初始化
    未初始化 --> 初始化中 : initialize()
    初始化中 --> 地形网格生成器初始化中 : 创建地形网格生成器
    地形网格生成器初始化中 --> 运行中 : 所有组件初始化成功
    地形网格生成器初始化中 --> 初始化失败 : 组件初始化错误
    初始化失败 --> 未初始化 : 重新初始化

    运行中 --> 更新中 : update()
    更新中 --> 相机位置更新中 : 更新相机位置
    相机位置更新中 --> 地形网格更新中 : 相机位置更新完成
    地形网格更新中 --> 法线计算中 : 地形网格更新完成
    法线计算中 --> 运行中 : 更新完成

    运行中 --> 高度查询中 : getHeightAt()
    高度查询中 --> 数据查找中 : 开始查询
    数据查找中 --> 插值计算中 : 数据查找完成
    插值计算中 --> 运行中 : 高度查询完成

    运行中 --> 法线查询中 : getTerrainNormal()
    法线查询中 --> 数据查找中 : 开始查询
    数据查找中 --> 法线计算中 : 数据查找完成
    法线计算中 --> 运行中 : 法线查询完成

    运行中 --> 配置更新中 : setConfig()
    配置更新中 --> 组件重新配置中 : 配置更新
    组件重新配置中 --> 运行中 : 重新配置完成

    运行中 --> 禁用状态 : enableTerrainHeight(false)
    禁用状态 --> 运行中 : enableTerrainHeight(true)

    运行中 --> 暂停 : 系统暂停
    暂停 --> 运行中 : 系统恢复

    运行中 --> 销毁中 : dispose()
    禁用状态 --> 销毁中 : dispose()
    销毁中 --> 已销毁 : 销毁完成
    已销毁 --> [*]
```

## 时序图设计

```mermaid
sequenceDiagram
    participant Globe
    participant TerrainHeightSystem
    participant TerrainMeshGenerator
    participant TileLoader
    participant Camera

    Globe->>TerrainHeightSystem: initialize()
    TerrainHeightSystem->>TerrainMeshGenerator: 创建地形网格生成器
    TerrainHeightSystem->>TerrainMeshGenerator: initialize()

    loop 渲染循环
        Globe->>TerrainHeightSystem: update(cameraPosition)
        TerrainHeightSystem->>TerrainMeshGenerator: 更新地形网格
        TerrainMeshGenerator->>TerrainMeshGenerator: 计算LOD和需要的高度图瓦片
        TerrainMeshGenerator->>TileLoader: 请求高度图瓦片数据
        TileLoader->>TerrainMeshGenerator: 返回高度图瓦片数据
        TerrainMeshGenerator->>TerrainMeshGenerator: 处理terrain-rgb数据并生成地形网格
    end

    Globe->>TerrainHeightSystem: getHeightAt(longitude, latitude)
    TerrainHeightSystem->>TerrainMeshGenerator: 查询地形高度
    TerrainMeshGenerator->>TerrainMeshGenerator: 检查缓存的高度图数据
    alt 数据已缓存
        TerrainMeshGenerator->>TerrainHeightSystem: 返回地形高度
    else 数据未缓存
        TerrainMeshGenerator->>TileLoader: 请求对应位置的高度图瓦片
        TileLoader->>TerrainMeshGenerator: 返回高度图瓦片数据
        TerrainMeshGenerator->>TerrainHeightSystem: 返回地形高度
    end
    TerrainHeightSystem->>Globe: 返回地形高度

    Globe->>TerrainHeightSystem: getTerrainNormal(longitude, latitude)
    TerrainHeightSystem->>TerrainMeshGenerator: 查询地形法线
    TerrainMeshGenerator->>TerrainHeightSystem: 返回地形法线
    TerrainHeightSystem->>Globe: 返回地形法线

    Globe->>TerrainHeightSystem: setConfig(newConfig)
    TerrainHeightSystem->>TerrainMeshGenerator: 更新网格配置

    Globe->>TerrainHeightSystem: enableTerrainHeight(enabled)
    TerrainHeightSystem->>TerrainHeightSystem: 启用或禁用地形高度渲染

    Globe->>TerrainHeightSystem: dispose()
    TerrainHeightSystem->>TerrainMeshGenerator: dispose()
    TerrainHeightSystem->>TerrainHeightSystem: 清理所有资源
```

## 核心算法设计

### 高度图数据处理算法

高度图数据处理算法处理terrain-rgb格式的高度图数据，将RGB值转换为高程数据。算法通过解析RGB通道值，使用terrain-rgb标准公式计算实际高程，支持全球范围的高精度地形数据。

### 地形网格生成算法

地形网格生成算法基于高程数据生成3D地形网格。算法将2D高程数据转换为3D顶点数据，计算法线和纹理坐标，生成适合渲染的三角形网格。算法支持不同分辨率的网格生成和自适应细分。

### 法线计算算法

法线计算算法为地形网格计算平滑的法线向量。算法通过分析相邻顶点的位置关系，使用叉积计算表面法线，支持法线平滑处理，确保地形表面的光照效果自然。

### 高度插值算法

高度插值算法计算任意位置的地形高度。算法使用双线性插值或三次样条插值，根据周围的高程数据点计算精确的高度值，支持平滑的高度查询。

## 配置参数

### TerrainHeightConfig

| 参数       | 类型              | 默认值 | 说明                 |
| ---------- | ----------------- | ------ | -------------------- |
| enabled    | boolean           | true   | 是否启用地形高度渲染 |
| meshConfig | MeshConfiguration | -      | 网格配置             |

### MeshConfiguration

| 参数                    | 类型    | 默认值 | 说明             |
| ----------------------- | ------- | ------ | ---------------- |
| enableHeightMaps        | boolean | true   | 是否启用高度图   |
| heightScale             | number  | 10000  | 高度缩放比例     |
| meshResolution          | number  | 64     | 网格分辨率       |
| enableNormalCalculation | boolean | true   | 是否启用法线计算 |
| normalSmoothing         | boolean | true   | 是否启用法线平滑 |

## 性能优化

### 网格优化

- **视锥剔除**：只渲染相机视野内的地形
- **批次渲染**：合并多个地形渲染调用
- **实例化渲染**：使用GPU实例化技术

### 内存优化

- **网格简化**：减少不必要的顶点和三角形
- **顶点合并**：合并相似的顶点减少内存使用
- **高度图压缩**：压缩高度图数据减少存储空间

### 数据优化

- **增量加载**：只加载可见区域的地形数据
- **数据压缩**：压缩高程数据减少存储空间
- **智能缓存**：缓存常用的地形数据

### 计算优化

- **空间分割**：使用空间数据结构加速查询
- **预计算**：预计算常用的地形信息
- **近似算法**：使用近似算法简化复杂计算

## 错误处理

### 数据加载错误处理

- **高度图格式错误**：处理无效的高度图数据格式
- **数据完整性错误**：验证高度图数据的完整性
- **内存不足错误**：处理高度图数据加载内存不足
- **网络错误**：处理高度图数据网络加载失败

### 网格生成错误处理

- **网格生成错误**：处理地形网格生成异常
- **法线计算错误**：处理法线计算异常
- **顶点数据错误**：处理顶点数据异常
- **索引数据错误**：处理索引数据异常

### 计算错误处理

- **数值溢出错误**：处理地形计算中的数值溢出
- **除零错误**：处理除零运算的情况
- **精度损失错误**：处理浮点运算精度损失
- **参数验证错误**：验证地形计算参数的有效性

### 系统错误处理

- **初始化错误**：处理系统初始化异常
- **配置错误**：处理配置参数验证错误
- **内存管理错误**：处理内存管理异常
