# 地球渲染模块设计

## 模块概述

地球渲染模块是 OpenEarth 系统的地球表面渲染协调器，负责整合瓦片贴图、地形高度和夜间灯光三个渲染效果。该模块作为渲染层的协调器，通过依赖注入的方式使用瓦片贴图模块、地形高度模块和夜间灯光模块，为地球提供完整的地表渲染效果。

该模块采用基于依赖注入的协调架构设计，通过 EarthRenderer 作为主控制器，协调三个子模块的工作流程。模块协调功能通过构造函数注入的方式获取瓦片贴图模块、地形高度模块和夜间灯光模块的实例，确保模块间的松耦合关系。渲染整合功能将三个渲染效果整合到最终的渲染结果中，根据功能开关状态决定是否应用瓦片贴图、地形高度和夜间灯光效果。功能控制提供三个功能的独立开关控制，用户可以根据需要开启或关闭瓦片贴图、地形高度或夜间灯光效果，实现灵活的地球渲染配置。时间同步通过订阅时间系统模块的时间变化事件，当接收到时间变化通知时自动更新太阳位置和光照效果，确保地球渲染与系统时间保持同步。统一接口为上层调用者提供简洁的API接口，隐藏底层模块的复杂性，提供一致的使用体验。

## 模块职责

- **模块协调**：整合瓦片贴图模块、地形高度模块和夜间灯光模块
- **渲染整合**：将三个渲染效果整合到最终结果
- **功能控制**：提供三个功能的独立开关控制
- **统一接口**：为上层调用者提供统一的API接口
- **时间同步**：响应时间变化，更新渲染效果

## 类图设计

```mermaid
classDiagram
    class EarthRenderer {
        -scene: Scene
        -camera: Camera
        -tileTextureRenderer: TileTextureRenderer
        -terrainHeightSystem: TerrainHeightSystem
        -nightLightRenderer: NightLightRenderer
        -isInitialized: boolean
        -config: EarthRendererConfig
        -enableTileTextures: boolean
        -enableTerrainHeight: boolean
        -enableDayNightLighting: boolean
        +constructor(scene: Scene, camera: Camera, tileTextureRenderer: TileTextureRenderer, terrainHeightSystem: TerrainHeightSystem, nightLightRenderer: NightLightRenderer, config: EarthRendererConfig)
        +initialize(): Promise~void~
        +dispose(): void
        +update(cameraPosition: Vector3): void
        +onTimeChanged(time: Date): void
        +setTileTexturesEnabled(enabled: boolean): void
        +setTerrainHeightEnabled(enabled: boolean): void
        +setDayNightLightingEnabled(enabled: boolean): void
        +getTileTexturesEnabled(): boolean
        +getTerrainHeightEnabled(): boolean
        +getDayNightLightingEnabled(): boolean
        +setConfig(config: EarthRendererConfig): void
        +getConfig(): EarthRendererConfig
        +getHeightAt(longitude: number, latitude: number): Promise~number~
    }
    
    class EarthRendererConfig {
        +enabled: boolean
        +enableTileTextures: boolean
        +enableTerrainHeight: boolean
        +enableDayNightLighting: boolean
    }
    
    class TileTextureRenderer {
        <<external>>
        +update(cameraPosition: Vector3): void
        +getActiveTextureCount(): number
        +getCachedTextureCount(): number
    }
    
    class TerrainHeightSystem {
        <<external>>
        +update(cameraPosition: Vector3): void
        +getHeightAt(longitude: number, latitude: number): Promise~number~
        +enableTerrainHeight(enabled: boolean): void
    }
    
    class NightLightRenderer {
        <<external>>
        +update(cameraPosition: Vector3, sunDirection: Vector3): void
        +onTimeChanged(time: Date): void
    }
    
    EarthRenderer --> TileTextureRenderer : 使用瓦片贴图模块
    EarthRenderer --> TerrainHeightSystem : 使用地形高度模块
    EarthRenderer --> NightLightRenderer : 使用夜间灯光模块
    EarthRenderer --> EarthRendererConfig : 使用配置
```

## 状态图设计

```mermaid
stateDiagram-v2
    [*] --> 未初始化
    未初始化 --> 初始化中 : initialize()
    初始化中 --> 模块协调初始化中 : 初始化模块协调
    模块协调初始化中 --> 运行中 : 所有组件初始化成功
    模块协调初始化中 --> 初始化失败 : 组件初始化错误
    初始化失败 --> 未初始化 : 重新初始化
    
    运行中 --> 更新中 : update()
    更新中 --> 瓦片贴图模块更新中 : 更新瓦片贴图模块
    瓦片贴图模块更新中 --> 地形模块更新中 : 瓦片贴图模块更新完成
    地形模块更新中 --> 夜间灯光模块更新中 : 地形模块更新完成
    夜间灯光模块更新中 --> 运行中 : 更新完成
    
    运行中 --> 时间变化中 : onTimeChanged()
    时间变化中 --> 夜间灯光时间更新中 : 时间变化
    夜间灯光时间更新中 --> 运行中 : 时间更新完成
    
    运行中 --> 瓦片贴图切换中 : setTileTexturesEnabled()
    瓦片贴图切换中 --> 运行中 : 瓦片贴图状态更新完成
    
    运行中 --> 地形高度切换中 : setTerrainHeightEnabled()
    地形高度切换中 --> 运行中 : 地形高度状态更新完成
    
    运行中 --> 昼夜光照切换中 : setDayNightLightingEnabled()
    昼夜光照切换中 --> 运行中 : 昼夜光照状态更新完成
    
    运行中 --> 配置更新中 : setConfig()
    配置更新中 --> 组件重新配置中 : 配置更新
    组件重新配置中 --> 运行中 : 重新配置完成
    
    运行中 --> 高度查询中 : getHeightAt()
    高度查询中 --> 地形模块查询中 : 开始查询
    地形模块查询中 --> 运行中 : 高度查询完成
    
    运行中 --> 暂停 : 系统暂停
    暂停 --> 运行中 : 系统恢复
    
    运行中 --> 销毁中 : dispose()
    暂停 --> 销毁中 : dispose()
    销毁中 --> 已销毁 : 销毁完成
    已销毁 --> [*]
```

## 时序图设计

```mermaid
sequenceDiagram
    participant Globe
    participant TimeSystem
    participant EarthRenderer
    participant TileTextureRenderer
    participant TerrainHeightSystem
    participant NightLightRenderer
    participant SunSystem
    participant Camera
    
    Globe->>EarthRenderer: initialize()
    EarthRenderer->>EarthRenderer: 初始化模块协调
    
    Globe->>EarthRenderer: 订阅时间系统事件
    
    loop 渲染循环
        Globe->>TimeSystem: update(deltaTime)
        TimeSystem->>TimeSystem: 更新时间状态
        
        alt 时间发生变化
            TimeSystem->>EarthRenderer: 通知时间变化
            EarthRenderer->>NightLightRenderer: onTimeChanged(time)
            NightLightRenderer->>SunSystem: 获取太阳位置
            SunSystem->>NightLightRenderer: 返回太阳位置
            NightLightRenderer->>NightLightRenderer: 更新夜间灯光效果
        end
        
        Globe->>EarthRenderer: update(cameraPosition)
        EarthRenderer->>TileTextureRenderer: update(cameraPosition)
        TileTextureRenderer->>TileTextureRenderer: 更新瓦片贴图
        EarthRenderer->>TerrainHeightSystem: update(cameraPosition)
        TerrainHeightSystem->>TerrainHeightSystem: 更新地形高度
        EarthRenderer->>NightLightRenderer: update(cameraPosition, sunDirection)
        NightLightRenderer->>NightLightRenderer: 更新夜间灯光
    end
    
    Globe->>EarthRenderer: setTileTexturesEnabled(enabled)
    EarthRenderer->>EarthRenderer: 更新瓦片贴图状态
    EarthRenderer->>TileTextureRenderer: 启用或禁用瓦片贴图渲染
    
    Globe->>EarthRenderer: setTerrainHeightEnabled(enabled)
    EarthRenderer->>EarthRenderer: 更新地形高度状态
    EarthRenderer->>TerrainHeightSystem: enableTerrainHeight(enabled)
    TerrainHeightSystem->>EarthRenderer: 地形高度状态更新完成
    
    Globe->>EarthRenderer: setDayNightLightingEnabled(enabled)
    EarthRenderer->>EarthRenderer: 更新昼夜光照状态
    EarthRenderer->>NightLightRenderer: 启用或禁用夜间灯光效果
    
    Globe->>EarthRenderer: getHeightAt(longitude, latitude)
    EarthRenderer->>TerrainHeightSystem: getHeightAt(longitude, latitude)
    TerrainHeightSystem->>EarthRenderer: 返回地形高度
    EarthRenderer->>Globe: 返回地形高度
    
    Globe->>EarthRenderer: setConfig(newConfig)
    EarthRenderer->>EarthRenderer: 更新配置参数
    
    Globe->>EarthRenderer: dispose()
    EarthRenderer->>EarthRenderer: 清理所有资源
```

## 核心算法设计

### 模块协调算法

模块协调算法负责整合三个子模块的工作流程。算法根据功能开关状态，协调瓦片贴图模块、地形高度模块和夜间灯光模块的更新顺序，确保三个效果能够正确叠加和显示。

### 渲染整合算法

渲染整合算法将三个渲染效果整合到最终的渲染结果中。算法根据功能开关状态，决定是否应用瓦片贴图、地形高度和夜间灯光效果，确保三个效果能够正确组合和显示。

### 功能控制算法

功能控制算法管理三个功能的启用和禁用状态。算法通过统一的接口控制各个子模块的启用状态，提供灵活的功能配置能力。

### 高度查询代理算法

高度查询代理算法将高度查询请求转发给地形高度模块。算法作为代理层，为上层调用者提供统一的高度查询接口，隐藏底层模块的复杂性。

## 配置参数

### EarthRendererConfig

| 参数                   | 类型    | 默认值 | 说明             |
| ---------------------- | ------- | ------ | ---------------- |
| enabled                | boolean | true   | 是否启用地球渲染 |
| enableTileTextures     | boolean | true   | 是否启用瓦片贴图 |
| enableTerrainHeight    | boolean | true   | 是否启用地形高度 |
| enableDayNightLighting | boolean | true   | 是否启用昼夜光照 |

## 性能优化

### 协调优化

- **依赖注入**：通过依赖注入减少模块耦合
- **事件驱动**：使用事件机制减少轮询开销
- **状态缓存**：缓存模块状态减少重复计算
- **异步处理**：异步处理非关键路径操作

### 接口优化

- **统一接口**：提供统一的API接口减少调用复杂度
- **代理模式**：使用代理模式隐藏底层复杂性
- **批量操作**：支持批量配置更新减少调用次数
- **状态同步**：优化模块间状态同步机制

### 内存优化

- **轻量级协调器**：协调器本身不占用大量内存
- **引用传递**：通过引用传递避免数据复制
- **状态管理**：高效的状态管理减少内存占用
- **资源复用**：复用子模块的资源减少重复分配

## 错误处理

### 模块协调错误处理

- **依赖模块错误**：处理瓦片贴图模块、地形高度模块和夜间灯光模块的错误
- **初始化错误**：处理模块初始化异常
- **状态同步错误**：处理模块间状态同步异常
- **配置错误**：处理配置参数验证错误

### 接口错误处理

- **参数验证错误**：处理API参数验证错误
- **调用异常错误**：处理子模块调用异常
- **状态不一致错误**：处理模块状态不一致异常
- **超时错误**：处理模块调用超时异常

### 系统错误处理

- **内存管理错误**：处理内存管理异常
- **性能监控错误**：处理性能监控异常
- **时间同步错误**：处理时间系统同步异常
- **渲染状态错误**：处理渲染状态异常
