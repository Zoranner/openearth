# 地球核心模块设计

## 模块概述

地球核心模块是 OpenEarth 系统的核心控制器，负责系统的统一入口、生命周期管理、配置管理和时间系统管理。作为系统的中枢，它协调各个功能模块的工作，确保系统的稳定运行。

该模块基于 Babylon.js 引擎的 Scene 和 Engine 架构设计，通过 Engine 实例管理 WebGL 上下文和渲染设备，通过 Scene 实例管理 3D 场景中的所有对象和渲染状态。模块采用观察者模式，使用 Babylon.js 的 Observable 系统实现模块间的事件通信，通过 Scene.registerBeforeRender() 注册渲染循环回调，确保各模块在每帧渲染前完成状态更新。时间系统管理采用全局时间管理器模式，通过 TimeSystem 模块统一管理系统时间，向所有需要时间信息的模块广播时间变化事件，实现时间同步和协调。配置管理采用深度合并策略，支持运行时动态配置更新，通过 TypeScript 的泛型和接口约束确保配置类型安全。生命周期管理遵循标准的初始化-运行-销毁模式，在初始化阶段按依赖关系顺序创建各子模块（优先创建时间系统，然后创建依赖时间的模块），在销毁阶段按相反顺序清理资源，确保无内存泄漏。错误处理采用统一的异常捕获机制，通过自定义错误类型和错误码实现精确的错误定位和恢复策略。

## 模块职责

- **系统初始化**：系统启动和模块初始化管理
- **生命周期管理**：系统运行状态和资源生命周期控制
- **配置管理**：系统参数配置和动态调整
- **时间系统管理**：全局时间管理和时间事件分发

## 类图设计

```mermaid
classDiagram
    class Globe {
        -canvas: HTMLCanvasElement
        -engine: Engine
        -scene: Scene
        -camera: ArcRotateCamera
        -config: GlobeConfig
        -isInitialized: boolean
        -timeSystem: TimeSystem
        -tileLoader: TileLoader
        -earthRenderer: EarthRenderer
        -atmosphereRenderer: AtmosphereRenderer
        -sunSystem: SunSystem
        -cameraController: CameraController
        +constructor(config: GlobeConfig)
        +initialize(): Promise~void~
        +dispose(): void
        +flyTo(longitude: number, latitude: number, altitude?: number): void
        +updateConfig(newConfig: Partial~GlobeConfig~): void
        +getConfig(): GlobeConfig
        +getTimeSystem(): TimeSystem
    }

    class GlobeConfig {
        +container: HTMLCanvasElement
        +zoom?: number
        +minZoom?: number
        +maxZoom?: number
        +center?: [number, number]
        +altitude?: number
        +sources?: SourcesConfig
        +layers?: LayersConfig
        +controls?: ControlsConfig
    }

    Globe --> GlobeConfig : 使用配置

    class SourcesConfig {
        +[key: string]: SourceConfig
    }

    class SourceConfig {
        +type: string
        +url?: string
        +attribution?: string
    }

    class LayersConfig {
        +[key: string]: LayerConfig
    }

    class LayerConfig {
        +source: string
        +type: string
        +visible?: boolean
        +opacity?: number
    }

    class ControlsConfig {
        +enableZoom?: boolean
        +enableRotate?: boolean
        +enablePan?: boolean
    }

    class TimeSystemConfig {
        +initialTime?: Date
        +timeScale?: number
        +enableRealTime?: boolean
        +enablePause?: boolean
        +enableReset?: boolean
        +enableTimeJump?: boolean
        +timeZone?: number
        +enableTimeZoneConversion?: boolean
    }

    Globe --> TimeSystem : 管理时间系统
    Globe --> TileLoader : 管理瓦片加载器
    Globe --> EarthRenderer : 管理地球渲染器
    Globe --> AtmosphereRenderer : 管理大气渲染器
    Globe --> SunSystem : 管理太阳系统
    Globe --> CameraController : 管理相机控制器
    Globe --> GlobeConfig : 使用配置

    GlobeConfig --> SourcesConfig : 包含
    GlobeConfig --> LayersConfig : 包含
    GlobeConfig --> ControlsConfig : 包含
    GlobeConfig --> SunConfig : 包含
    GlobeConfig --> TimeSystemConfig : 包含
    SourcesConfig --> SourceConfig : 包含
    LayersConfig --> LayerConfig : 包含
```

## 状态图设计

```mermaid
stateDiagram-v2
    [*] --> 未初始化

    未初始化 --> 初始化中: initialize()
    初始化中 --> 时间系统初始化中: 引擎和场景创建完成
    时间系统初始化中 --> 组件初始化中: 时间系统初始化完成
    组件初始化中 --> 运行中: 所有组件初始化成功
    组件初始化中 --> 初始化失败: 组件初始化错误
    时间系统初始化中 --> 初始化失败: 时间系统初始化错误
    初始化失败 --> 未初始化: 重新初始化

    运行中 --> 配置更新中: updateConfig()
    配置更新中 --> 运行中: 配置更新完成
    配置更新中 --> 运行中: 配置更新失败

    运行中 --> 飞行中: flyTo()
    飞行中 --> 运行中: 飞行完成
    飞行中 --> 运行中: 飞行取消

    运行中 --> 暂停: 页面隐藏/失去焦点
    暂停 --> 运行中: 页面显示/获得焦点

    运行中 --> 销毁中: dispose()
    暂停 --> 销毁中: dispose()
    销毁中 --> 已销毁: 销毁完成
    已销毁 --> [*]
```

## 序列图设计

```mermaid
sequenceDiagram
    participant 用户
    participant Globe
    participant TimeSystem
    participant PlanetSphere
    participant TileLoader
    participant AtmosphereRenderer
    participant SunSystem
    participant NightLightRenderer
    participant CameraController

    用户->>Globe: new Globe(config)
    Globe->>Globe: 初始化 Babylon.js 引擎和场景

    用户->>Globe: initialize()
    Globe->>TimeSystem: 创建时间系统
    TimeSystem->>TimeSystem: 初始化时间管理器
    Globe->>TileLoader: 初始化瓦片加载器
    Globe->>EarthRenderer: 初始化地球渲染器
    Globe->>AtmosphereRenderer: 初始化大气层渲染器
    Globe->>SunSystem: 初始化太阳系统
    Globe->>CameraController: 初始化相机控制器

    Globe->>SunSystem: 订阅时间系统事件
    Globe->>AtmosphereRenderer: 订阅时间系统事件
    Globe->>EarthRenderer: 订阅时间系统事件

    loop 渲染循环
        Globe->>TimeSystem: update(deltaTime)
        TimeSystem->>TimeSystem: 更新时间状态

        alt 时间发生变化
            TimeSystem->>SunSystem: 通知时间变化
            TimeSystem->>AtmosphereRenderer: 通知时间变化
            TimeSystem->>EarthRenderer: 通知时间变化
        end

        Globe->>TileLoader: update(cameraPosition)
        Globe->>EarthRenderer: update(cameraPosition)
        Globe->>CameraController: update()
        Globe->>Globe: scene.render()
    end

    用户->>Globe: flyTo(longitude, latitude, altitude)
    Globe->>CameraController: flyTo(longitude, latitude, altitude)

    用户->>Globe: updateConfig(newConfig)
    Globe->>Globe: 更新配置参数

    用户->>Globe: getConfig()
    Globe->>用户: 返回当前配置

    用户->>Globe: dispose()
    Globe->>TileLoader: dispose()
    Globe->>EarthRenderer: dispose()
    Globe->>AtmosphereRenderer: dispose()
    Globe->>SunSystem: dispose()
    Globe->>CameraController: dispose()
    Globe->>Globe: 清理所有资源
```
