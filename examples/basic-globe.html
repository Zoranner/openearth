<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenGlobus - Basic Globe Example</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }
        
        #renderCanvas {
            width: 100vw;
            height: 100vh;
            display: block;
            outline: none;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #4CAF50;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .control-group button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background 0.3s;
        }
        
        .control-group button:hover {
            background: #45a049;
        }
        
        .control-group select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            color: #ccc;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading OpenGlobus...</div>
    </div>
    
    <div class="controls">
        <h3>üåç OpenGlobus Controls</h3>
        
        <div class="control-group">
            <label>Quick Locations:</label>
            <button onclick="flyToLocation(0, 0)">Equator</button>
            <button onclick="flyToLocation(116.4074, 39.9042)">Beijing</button>
            <button onclick="flyToLocation(-74.006, 40.7128)">New York</button>
            <button onclick="flyToLocation(2.3522, 48.8566)">Paris</button>
        </div>
        
        <div class="control-group">
            <label>Tile Provider:</label>
            <select id="tileProvider" onchange="changeTileProvider()">
                <option value="https://tile.openstreetmap.org">OpenStreetMap</option>
                <option value="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile">Satellite</option>
                <option value="https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile">Terrain</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Time of Day:</label>
            <input type="range" id="timeSlider" min="0" max="24" step="0.1" value="12" onchange="updateTime()">
            <span id="timeDisplay">12:00</span>
        </div>
        
        <div class="control-group">
             <label>Latitude:</label>
             <input type="range" id="latitudeSlider" min="-90" max="90" step="1" value="39" onchange="updateLatitude()">
             <span id="latitudeDisplay">39¬∞N</span>
         </div>
         
         <div class="control-group">
             <label>Night Light Intensity:</label>
             <input type="range" id="nightIntensitySlider" min="0" max="2" step="0.1" value="1" onchange="updateNightIntensity()">
             <span id="nightIntensityDisplay">1.0</span>
         </div>
         
         <div class="control-group">
             <label>Night Light Brightness:</label>
             <input type="range" id="nightBrightnessSlider" min="0" max="2" step="0.1" value="0.8" onchange="updateNightBrightness()">
             <span id="nightBrightnessDisplay">0.8</span>
         </div>
         
         <div class="control-group">
             <label>Actions:</label>
             <button onclick="toggleDayNightCycle()">Toggle Day/Night Cycle</button>
             <button onclick="loadDetailedArea()">Load Europe Detail</button>
             <button onclick="resetView()">Reset View</button>
         </div>
         
         <h3>üèîÔ∏è Terrain Controls</h3>
         
         <div class="control-group">
             <label>
                 <input type="checkbox" id="terrainOptimization" checked onchange="toggleTerrainOptimization(this.checked)">
                 Enable Terrain Optimization
             </label>
         </div>
         
         <div class="control-group">
             <label>
                 <input type="checkbox" id="heightMaps" checked onchange="toggleHeightMaps(this.checked)">
                 Enable Height Maps
             </label>
         </div>
         
         <div class="control-group">
             <label>
                 <input type="checkbox" id="normalMaps" checked onchange="toggleNormalMaps(this.checked)">
                 Enable Normal Maps
             </label>
         </div>
         
         <div class="control-group">
             <label>Height Scale:</label>
             <input type="range" id="heightScaleSlider" min="1000" max="20000" step="1000" value="10000" onchange="updateHeightScale()">
             <span id="heightScaleDisplay">10000m</span>
         </div>
         
         <div class="control-group">
             <label>Detail Scale:</label>
             <input type="range" id="detailScaleSlider" min="1" max="32" step="1" value="16" onchange="updateDetailScale()">
             <span id="detailScaleDisplay">16x</span>
         </div>
    </div>
    
    <div class="info" id="info">
        <div>üìç Camera Position: <span id="cameraPos">Loading...</span></div>
        <div>üó∫Ô∏è Active Tiles: <span id="activeTiles">0</span></div>
        <div>üíæ Cached Tiles: <span id="cachedTiles">0</span></div>
        <div>‚ö° FPS: <span id="fps">0</span></div>
        <div>‚è±Ô∏è Frame Time: <span id="frameTime">0ms</span></div>
        <div>üé® Draw Calls: <span id="drawCalls">0</span></div>
    </div>
    
    <canvas id="renderCanvas"></canvas>
    
    <script type="module">
        import { createBasicGlobe } from '../src/examples/basic-globe.js';
        
        let globeExample = null;
        let fpsCounter = 0;
        let lastTime = performance.now();
        
        // Initialize the globe
        async function initializeGlobe() {
            try {
                const canvas = document.getElementById('renderCanvas');
                globeExample = await createBasicGlobe(canvas);
                
                // Hide loading screen
                document.getElementById('loading').classList.add('hidden');
                
                // Start info updates
                startInfoUpdates();
                
                console.log('Globe initialized successfully');
            } catch (error) {
                console.error('Failed to initialize globe:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #f44336;">‚ùå Failed to load OpenGlobus</div>
                    <div style="font-size: 12px; margin-top: 10px;">${error.message}</div>
                `;
            }
        }
        
        // Start info panel updates
        function startInfoUpdates() {
            let frameTimeSum = 0;
            let frameTimeCount = 0;
            
            setInterval(() => {
                if (globeExample && globeExample.scene.activeCamera) {
                    // Update camera position
                    const pos = globeExample.scene.activeCamera.position;
                    document.getElementById('cameraPos').textContent = 
                        `(${pos.x.toFixed(0)}, ${pos.y.toFixed(0)}, ${pos.z.toFixed(0)})`;
                    
                    // Update tile counts (if available)
                    const tileLoader = globeExample.globe.tileLoader;
                    if (tileLoader) {
                        document.getElementById('activeTiles').textContent = tileLoader.activeTileCount;
                        document.getElementById('cachedTiles').textContent = tileLoader.cachedTileCount;
                    }
                    
                    // Update performance stats
                    const currentTime = performance.now();
                    const deltaTime = currentTime - lastTime;
                    
                    // Calculate frame time average
                    frameTimeSum += deltaTime;
                    frameTimeCount++;
                    
                    fpsCounter++;
                    if (currentTime - lastTime >= 1000) {
                        // Update FPS
                        document.getElementById('fps').textContent = fpsCounter;
                        
                        // Update average frame time
                        const avgFrameTime = frameTimeSum / frameTimeCount;
                        document.getElementById('frameTime').textContent = avgFrameTime.toFixed(1) + 'ms';
                        
                        // Update draw calls (if available)
                        if (globeExample.scene && globeExample.scene.getEngine()) {
                            const engine = globeExample.scene.getEngine();
                            const drawCalls = engine.drawCalls || 0;
                            document.getElementById('drawCalls').textContent = drawCalls;
                        }
                        
                        // Reset counters
                        fpsCounter = 0;
                        frameTimeSum = 0;
                        frameTimeCount = 0;
                        lastTime = currentTime;
                    }
                }
            }, 100);
        }
        
        // Global functions for controls
        window.flyToLocation = function(longitude, latitude, altitude = 1000000) {
            if (globeExample) {
                globeExample.flyTo(longitude, latitude, altitude);
            }
        };
        
        window.changeTileProvider = function() {
            const select = document.getElementById('tileProvider');
            const baseUrl = select.value;
            
            if (globeExample && globeExample.globe.tileLoader) {
                globeExample.globe.tileLoader.setTileProvider(baseUrl);
                console.log('Tile provider changed to:', baseUrl);
            }
        };
        
        window.loadDetailedArea = async function() {
            if (globeExample) {
                try {
                    // Load detailed tiles for Europe
                    await globeExample.loadArea(-10, 30, 35, 70, 8);
                    console.log('Detailed area loaded for Europe');
                } catch (error) {
                    console.error('Failed to load detailed area:', error);
                }
            }
        };
        
        window.resetView = function() {
            if (globeExample && globeExample.globe.camera) {
                const camera = globeExample.globe.camera;
                const earthRadius = globeExample.globe.earthRadius;
                
                camera.setTarget(new BABYLON.Vector3(0, 0, 0));
                camera.setPosition(new BABYLON.Vector3(0, 0, earthRadius * 3));
            }
        };
        
        window.updateTime = function() {
             const timeSlider = document.getElementById('timeSlider');
             const timeValue = parseFloat(timeSlider.value);
             const hours = Math.floor(timeValue);
             const minutes = Math.floor((timeValue - hours) * 60);
             
             document.getElementById('timeDisplay').textContent = 
                 `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
             
             if (globe && globe.sunSystem) {
                 globe.sunSystem.setTimeOfDay(timeValue);
             }
         };
         
         window.updateLatitude = function() {
             const latSlider = document.getElementById('latitudeSlider');
             const latValue = parseFloat(latSlider.value);
             
             document.getElementById('latitudeDisplay').textContent = 
                 `${Math.abs(latValue)}¬∞${latValue >= 0 ? 'N' : 'S'}`;
             
             if (globe && globe.sunSystem) {
                 globe.sunSystem.setLatitude(latValue);
             }
         };
         
         window.updateNightIntensity = function() {
             const slider = document.getElementById('nightIntensitySlider');
             const value = parseFloat(slider.value);
             
             document.getElementById('nightIntensityDisplay').textContent = value.toFixed(1);
             
             if (globe && globe.nightLightRenderer) {
                 globe.nightLightRenderer.setIntensity(value);
             }
         };
         
         window.updateNightBrightness = function() {
             const slider = document.getElementById('nightBrightnessSlider');
             const value = parseFloat(slider.value);
             
             document.getElementById('nightBrightnessDisplay').textContent = value.toFixed(1);
             
             if (globe && globe.nightLightRenderer) {
                 globe.nightLightRenderer.setBrightness(value);
             }
         };
         
         window.toggleDayNightCycle = function() {
             if (globe && globe.sunSystem) {
                 isDayNightCycleActive = !isDayNightCycleActive;
                 if (isDayNightCycleActive) {
                     globe.sunSystem.startDayNightCycle(24000); // 24 seconds = 1 day
                 } else {
                     globe.sunSystem.stopDayNightCycle();
                 }
                 const button = event.target;
                 button.textContent = isDayNightCycleActive ? 'Stop Day/Night Cycle' : 'Start Day/Night Cycle';
                 button.style.background = isDayNightCycleActive ? '#f44336' : '#4CAF50';
             }
         };
         
         // Terrain control functions
         window.toggleTerrainOptimization = function(enabled) {
             if (globeExample && globeExample.globe.terrainOptimizer) {
                 globeExample.globe.terrainOptimizer.setEnabled(enabled);
                 console.log('Terrain optimization:', enabled ? 'enabled' : 'disabled');
             }
         };
         
         window.toggleHeightMaps = function(enabled) {
             if (globeExample && globeExample.globe.terrainDetailRenderer) {
                 globeExample.globe.terrainDetailRenderer.setHeightMapsEnabled(enabled);
                 console.log('Height maps:', enabled ? 'enabled' : 'disabled');
             }
         };
         
         window.toggleNormalMaps = function(enabled) {
             if (globeExample && globeExample.globe.terrainDetailRenderer) {
                 globeExample.globe.terrainDetailRenderer.setNormalMapsEnabled(enabled);
                 console.log('Normal maps:', enabled ? 'enabled' : 'disabled');
             }
         };
         
         window.updateHeightScale = function() {
             const slider = document.getElementById('heightScaleSlider');
             const value = parseFloat(slider.value);
             
             document.getElementById('heightScaleDisplay').textContent = value + 'm';
             
             if (globeExample && globeExample.globe.terrainDetailRenderer) {
                 globeExample.globe.terrainDetailRenderer.setHeightScale(value);
             }
         };
         
         window.updateDetailScale = function() {
             const slider = document.getElementById('detailScaleSlider');
             const value = parseFloat(slider.value);
             
             document.getElementById('detailScaleDisplay').textContent = value + 'x';
             
             if (globeExample && globeExample.globe.terrainDetailRenderer) {
                 globeExample.globe.terrainDetailRenderer.setDetailScale(value);
             }
         };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeGlobe);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (globeExample) {
                globeExample.engine.resize();
            }
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (globeExample) {
                globeExample.dispose();
            }
        });
    </script>
</body>
</html>